# Change: 整合用户角色与授权管理

## Why

当前系统存在以下问题：

1. **用户与角色未关联**：用户管理界面没有角色分配功能，虽然后端已有 `AssignRoleToUser` API，但前端未实现
2. **授权分散**：资产授权是基于用户直接授权（`user_assets` 表），而非基于角色授权
3. **权限模型不完整**：
   - 管理员角色（`is_admin=true`）可以访问所有资产
   - 普通用户需要逐个授权资产，无法通过角色批量授权
   - 缺乏"角色→资产"的授权关系

## What Changes

### 数据模型变更
- **ADDED**: `RoleAsset` 关联表 - 存储角色与资产的授权关系（角色级别的资产授权）

### 后端服务变更
- **ADDED**: 角色资产授权 API - 为角色分配可访问的资产
- **MODIFIED**: 授权服务 - 检查用户权限时，同时检查用户直接授权和角色授权
- **ADDED**: 用户角色管理 API 增强 - 获取用户角色、批量分配角色

### 前端变更
- **ADDED**: 用户管理 - 角色分配功能（显示用户角色、分配/移除角色）
- **ADDED**: 角色管理 - 资产授权功能（为角色分配可访问的资产）
- **MODIFIED**: 授权逻辑 - 用户可见资产 = 直接授权资产 + 角色授权资产

## Impact

- **Affected specs**: user-role-authorization (new)
- **Affected code**:
  - `backend/internal/model/` - 新增 RoleAsset 模型
  - `backend/internal/service/authorization/` - 扩展权限检查逻辑
  - `backend/internal/handler/role/` - 角色资产授权 handler
  - `backend/internal/handler/user/` - 用户角色管理 handler
  - `frontend/src/pages/users/UserList.tsx` - 增加角色分配功能
  - `frontend/src/pages/roles/RoleList.tsx` - 增加资产授权功能
  - `frontend/src/api/role.ts` - 新增角色资产授权 API
  - `frontend/src/api/user.ts` - 新增用户角色管理 API

## Database Changes

```sql
-- 新增角色资产授权表
CREATE TABLE role_assets (
    role_id BIGINT NOT NULL,
    asset_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    PRIMARY KEY (role_id, asset_id),
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (asset_id) REFERENCES assets(id) ON DELETE CASCADE
);
```

## Authorization Flow (Updated)

```
用户请求资产
    ↓
检查用户角色 → is_admin = true? → 允许访问所有资产
    ↓ (否)
检查 user_assets 表 → 有直接授权记录? → 允许访问
    ↓ (否)
检查 role_assets 表（通过用户角色）→ 有角色授权记录? → 允许访问
    ↓ (否)
拒绝访问 (403 Forbidden)
```

## UI Design Preview

### 用户管理 - 角色分配
```
| ID | 用户名 | 邮箱           | 角色              | 状态 | 操作                    |
|----|--------|----------------|-------------------|------|-------------------------|
| 1  | admin  | admin@test.com | [管理员]          | 启用 | 角色 授权 编辑 删除     |
| 2  | ops01  | ops@test.com   | [运维] [开发]     | 启用 | 角色 授权 编辑 删除     |
| 3  | dev01  | dev@test.com   | [开发]            | 启用 | 角色 授权 编辑 删除     |
```

### 角色管理 - 资产授权
```
| ID | 角色名称 | 管理员    | 描述         | 授权资产 | 操作                |
|----|----------|-----------|--------------|----------|---------------------|
| 1  | admin    | ✅ 管理员 | 系统管理员   | 全部     | 编辑 删除           |
| 2  | ops      | -         | 运维人员     | 15 台    | 授权 编辑 删除      |
| 3  | dev      | -         | 开发人员     | 8 台     | 授权 编辑 删除      |
```

### 角色资产授权弹窗
```
┌─ 资产授权 - ops ─────────────────────────────────────────────┐
│                                                               │
│  快速授权:                                                    │
│  ┌─────────────────┐  ┌─────────────────┐                    │
│  │ 选择项目 ▼      │  │ 选择环境 ▼      │  [添加到授权]      │
│  └─────────────────┘  └─────────────────┘                    │
│                                                               │
│  ┌─────────────── 未授权资产 ───────────────────────────┐    │
│  │ □ web-server-01  192.168.1.10  [生产环境]            │    │
│  │ □ web-server-02  192.168.1.11  [生产环境]            │    │
│  └──────────────────────────────────────────────────────┘    │
│                        ↓ ↑                                    │
│  ┌─────────────── 已授权资产 ───────────────────────────┐    │
│  │ □ api-server-01  192.168.1.5   [开发环境]            │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                               │
│                                    [取消]  [保存]             │
└───────────────────────────────────────────────────────────────┘
```

### 用户角色分配弹窗
```
┌─ 角色分配 - ops01 ──────────────────────────────────┐
│                                                      │
│  当前角色:                                           │
│  ┌──────────────────────────────────────────────┐   │
│  │ [运维] ✕   [开发] ✕                          │   │
│  └──────────────────────────────────────────────┘   │
│                                                      │
│  可分配角色:                                         │
│  ┌──────────────────────────────────────────────┐   │
│  │ ☐ 管理员  - 系统管理员（可访问所有资产）     │   │
│  │ ☑ 运维    - 运维人员                         │   │
│  │ ☑ 开发    - 开发人员                         │   │
│  │ ☐ 测试    - 测试人员                         │   │
│  └──────────────────────────────────────────────┘   │
│                                                      │
│                          [取消]  [保存]              │
└──────────────────────────────────────────────────────┘
```
