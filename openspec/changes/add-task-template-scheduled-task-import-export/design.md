# Design: 任务模板和任务执行导入导出功能

## Context

当前系统已有部署管理的导入导出功能实现，可以参考其设计模式。需要为任务模板（`TaskTemplate`）和任务执行（`ScheduledTask`）添加类似的功能。

### 关键差异点

1. **任务模板**：结构简单，只包含名称、描述、内容、类型，无关联资源（项目、环境、主机）
2. **任务执行**：结构复杂，包含：
   - Cron 表达式
   - 可选的模板关联
   - 主机列表（通过 AssetIDs 字符串存储）
   - 超时时间
   - 是否启用
   - 是否更新资产信息

## Goals / Non-Goals

### Goals
- 提供完整的导入导出功能，支持 JSON 格式
- 自动处理关联资源（主机、模板）的匹配
- 支持导入预览（验证但不创建）
- 处理重名情况的策略（跳过或更新）
- 清晰的错误提示和导入结果统计

### Non-Goals
- 不导出执行历史记录（仅导出配置）
- 不支持部分导出（只能全量导出所有配置）
- 不自动创建缺失的关联资源（如主机、模板不存在时给出错误）

## Decisions

### 1. JSON 格式设计

**任务模板导出格式**：
```json
{
  "version": "1.0",
  "export_at": "2025-01-27T10:00:00Z",
  "templates": [
    {
      "name": "系统信息采集",
      "description": "采集主机 CPU、内存、磁盘信息",
      "content": "#!/bin/bash\n\n...",
      "type": "shell"
    }
  ]
}
```

**任务执行导出格式**：
```json
{
  "version": "1.0",
  "export_at": "2025-01-27T10:00:00Z",
  "tasks": [
    {
      "name": "每日系统信息采集",
      "description": "每天午夜执行系统信息采集",
      "cron_expression": "0 0 * * * *",
      "template_name": "系统信息采集",  // 可选，模板名称
      "content": "#!/bin/bash\n\n...",  // 如果没有关联模板，使用此内容
      "type": "shell",
      "timeout": 600,
      "enabled": true,
      "update_assets": true,
      "target_hosts": ["host01", "192.168.1.1"]  // 主机名或 IP 列表
    }
  ]
}
```

**决策理由**：
- 使用主机名/IP 而非 ID，便于跨环境迁移
- 使用模板名称而非 ID，便于跨环境迁移
- 保留完整配置信息，确保导入后可还原

### 2. 导入策略

**任务模板导入**：
- 如果同名模板已存在：
  - 选项 A：跳过（推荐）- 避免覆盖已有配置
  - 选项 B：更新 - 覆盖同名模板
  - 选项 C：重命名 - 自动添加后缀
- **决策**：采用跳过策略，并在结果中记录跳过的项

**任务执行导入**：
- 如果同名任务已存在：
  - 选项 A：跳过（推荐）- 避免覆盖已有定时任务
  - 选项 B：更新 - 覆盖同名任务
- **决策**：采用跳过策略，并在结果中记录跳过的项
- 主机匹配：根据主机名或 IP 查找，部分找不到时给出警告但不阻止导入
- 模板匹配：根据模板名称查找，找不到时给出警告但不阻止导入（如果提供了自定义内容）

### 3. 错误处理

- **验证阶段**：
  - JSON 格式验证
  - 必填字段验证
  - Cron 表达式格式验证
- **导入阶段**：
  - 记录每个项的导入结果（成功/失败/跳过）
  - 失败时记录详细错误信息
  - 部分成功时仍继续处理剩余项
- **返回结果**：
  ```json
  {
    "total": 10,
    "success": 8,
    "failed": 1,
    "skipped": 1,
    "errors": ["任务 'test01': Cron 表达式格式错误"],
    "skipped_items": ["任务 'daily': 已存在，已跳过"]
  }
  ```

### 4. 前端实现

**导出流程**：
1. 点击"导出配置"按钮
2. 调用导出 API
3. 自动下载 JSON 文件（通过 Content-Disposition header）

**导入流程**：
1. 点击"导入配置"按钮
2. 打开文件选择对话框
3. 选择 JSON 文件
4. 可选：预览导入（调用预览 API）
5. 确认后执行导入
6. 显示导入结果（成功/失败/跳过统计）

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 导入时主机匹配失败 | 中 | 提供清晰错误信息，允许部分导入 |
| 导入时模板匹配失败 | 低 | 提供警告但允许继续（如果提供了自定义内容） |
| 大量数据导入性能问题 | 低 | 分批处理，限制单次导入数量 |
| JSON 格式版本兼容性 | 低 | 在 JSON 中包含版本号，未来可扩展 |

## Migration Plan

1. 实现任务模板导入导出（较简单，先做）
2. 实现任务执行导入导出（较复杂，依赖模板）
3. 前端 UI 集成
4. 测试验证

## Open Questions

1. 导入时是否支持更新已存在的任务？（当前决策：跳过）
2. 是否需要支持批量删除后再导入？（当前决策：不支持，手动删除）
3. 导入时是否自动启用任务？（当前决策：根据 JSON 中的 `enabled` 字段）
