# Change: 完善菜单功能权限授权

## Why

当前系统的角色授权只完成了针对主机（资产）部分的授权，菜单功能还没有权限控制。这导致：
1. 所有登录用户都可以看到所有菜单项，无法实现细粒度的功能权限控制
2. 即使在前端隐藏菜单，用户仍可能通过直接访问 URL 访问功能
3. 缺少针对不同菜单功能的权限分配机制

需要完善菜单功能的权限授权，实现：
- 基于角色的菜单权限控制
- 前端菜单显示/隐藏
- 后端 API 权限验证
- 管理员自动拥有所有权限

## What Changes

### 1. 权限定义

为各个菜单功能定义权限（resource/action）：

**基础设施**：
- `projects:*` - 项目管理（查看、创建、编辑、删除）
- `environments:*` - 环境管理
- `cloud-platforms:*` - 云平台管理
- `assets:*` - 资产管理（已有资产访问控制，此处为菜单权限）

**任务管理**：
- `executions:*` - 运维执行
- `templates:*` - 任务模板
- `tasks:*` - 任务执行
- `deployments:*` - 部署管理

**安全管理**：
- `ssh-keys:*` - SSH 密钥管理

**系统管理**：
- `users:*` - 用户管理
- `roles:*` - 角色权限管理
- `audit-logs:*` - 审计日志查看

**仪表板**：
- `dashboard:*` - 仪表板查看

### 2. 后端实现

- **权限初始化**：在数据库初始化时创建所有菜单权限
- **权限检查中间件**：在所有路由上添加权限检查
- **管理员自动权限**：管理员角色自动拥有所有权限
- **API 端点**：
  - `GET /api/v1/user/permissions` - 获取当前用户权限列表
  - 在角色管理界面中展示权限分配功能（已有基础，需要完善）

### 3. 前端实现

- **获取用户权限**：登录后获取用户权限列表
- **菜单权限控制**：根据权限显示/隐藏菜单项
- **路由保护**：在路由层面检查权限，无权限时重定向或显示 403
- **权限提示**：访问无权限页面时给出明确提示

### 4. 角色管理增强

- **权限分配界面**：在角色管理中添加权限分配功能
- **权限选择**：支持批量选择权限（按资源分组）
- **权限预览**：显示当前角色拥有的所有权限

## Impact

- **后端**：
  - 新增权限初始化逻辑
  - 在所有路由上添加权限检查中间件
  - 管理员检查逻辑需要同时检查 `IsAdmin` 和权限
  - API 响应中返回用户权限列表

- **前端**：
  - 菜单组件根据权限动态渲染
  - 路由守卫检查权限
  - 权限状态管理（Store）
  - 无权限页面的 UI 提示

- **数据库**：
  - 需要为所有菜单功能创建权限记录
  - 为管理员角色分配所有权限（可选，或通过 `IsAdmin` 自动授予）

- **兼容性**：
  - 现有管理员用户自动拥有所有权限（通过 `IsAdmin` 检查）
  - 普通用户需要显式分配权限才能访问菜单

## Open Questions

1. 权限粒度：是否需要将 `*` 拆分为 `read`、`create`、`update`、`delete` 等细粒度权限？
   - **决策**：当前阶段先使用 `*` 表示所有操作，后续可按需细化

2. 权限继承：子菜单权限是否需要继承父菜单权限？
   - **决策**：每个菜单项独立控制，不自动继承

3. 默认权限：新创建的角色是否需要默认权限？
   - **决策**：新建角色默认无权限，需要显式分配
