# Tasks: 完善菜单功能权限授权

## 1. 后端权限定义和初始化

- [x] 1.1 定义所有菜单权限
  - [x] 1.1.1 创建权限常量定义文件 `backend/internal/model/permissions.go`
  - [x] 1.1.2 定义所有菜单权限（resource/action）
  - [x] 1.1.3 创建权限描述和映射关系
- [x] 1.2 实现权限初始化逻辑
  - [x] 1.2.1 在 `backend/internal/config/database.go` 中添加 `seedMenuPermissions` 函数
  - [x] 1.2.2 检查并创建缺失的权限
  - [x] 1.2.3 在 `migrate` 函数中调用权限初始化
- [x] 1.3 权限初始化验证
  - [x] 1.3.1 验证所有权限已正确创建
  - [x] 1.3.2 测试权限初始化幂等性（重复执行不报错）

## 2. 后端权限检查增强

- [x] 2.1 增强权限检查服务
  - [x] 2.1.1 在 `rbac.Service.HasPermission` 中添加管理员自动通过逻辑
  - [x] 2.1.2 创建 `GetUserPermissionList` 方法返回用户所有权限（用于前端）
  - [ ] 2.1.3 实现权限缓存机制（可选，优化性能）
- [x] 2.2 添加用户权限 API
  - [x] 2.2.1 在 `handler/user` 中添加 `GetUserPermissions` 端点
  - [x] 2.2.2 返回当前用户的权限列表（resource/action 数组）
  - [x] 2.2.3 管理员返回所有权限列表
- [x] 2.3 路由权限检查
  - [x] 2.3.1 在 `backend/cmd/server/main.go` 中为所有路由添加权限检查中间件
  - [x] 2.3.2 定义路由与权限的映射关系
  - [x] 2.3.3 系统管理类路由限制为管理员角色
  - [ ] 2.3.4 测试所有 API 端点的权限检查

## 3. 前端权限获取和管理

- [x] 3.1 权限 API 客户端
  - [x] 3.1.1 在 `frontend/src/api/user.ts` 中添加 `getPermissions` 方法
  - [x] 3.1.2 定义权限相关 TypeScript 接口
- [x] 3.2 权限 Store
  - [x] 3.2.1 创建 `frontend/src/stores/permission.ts`（或扩展现有 Store）
  - [x] 3.2.2 存储用户权限列表
  - [x] 3.2.3 实现 `hasPermission(resource, action)` 方法
  - [x] 3.2.4 实现 `hasAnyPermission(permissions)` 方法
- [x] 3.3 登录时获取权限
  - [x] 3.3.1 在登录成功后获取用户权限
  - [x] 3.3.2 将权限存储到 Store
  - [x] 3.3.3 处理权限获取失败的情况

## 4. 前端菜单权限控制

- [x] 4.1 菜单权限映射
  - [x] 4.1.1 在 `frontend/src/layouts/MainLayout.tsx` 中定义菜单项与权限的映射
  - [x] 4.1.2 创建 `getMenuItemsWithPermission` 函数过滤菜单项
- [x] 4.2 菜单渲染控制
  - [x] 4.2.1 根据用户权限过滤菜单项
  - [x] 4.2.2 无权限时隐藏菜单项或显示禁用状态
  - [x] 4.2.3 管理员显示所有菜单项
- [x] 4.3 路由守卫
  - [x] 4.3.1 在 `frontend/src/components/ProtectedRoute.tsx` 中添加权限检查
  - [x] 4.3.2 无权限时重定向或显示 403 页面
  - [x] 4.3.3 创建 403 无权限页面组件

## 5. 角色管理权限分配

- [x] 5.1 权限列表 API
  - [x] 5.1.1 确保 `GET /api/v1/permissions` 端点可用（检查是否已存在）
  - [x] 5.1.2 返回所有权限列表，按 resource 分组
- [x] 5.2 角色权限分配 UI
  - [x] 5.2.1 在 `frontend/src/pages/roles/RoleList.tsx` 中添加权限分配功能
  - [x] 5.2.2 创建权限选择组件（按资源分组显示）
  - [x] 5.2.3 支持批量选择权限（全选、按资源选择）
  - [x] 5.2.4 显示当前角色已分配的权限
- [x] 5.3 权限分配 API 集成
  - [x] 5.3.1 调用 `AssignPermissionToRole` 和 `RemovePermissionFromRole` API
  - [x] 5.3.2 处理权限分配成功/失败提示
  - [x] 5.3.3 刷新权限列表

## 6. 测试和验证

- [ ] 6.1 后端测试
  - [ ] 6.1.1 测试权限初始化功能
  - [ ] 6.1.2 测试权限检查中间件（有权限/无权限场景）
  - [ ] 6.1.3 测试管理员自动通过权限检查
  - [ ] 6.1.4 测试用户权限获取 API
- [ ] 6.2 前端测试
  - [ ] 6.2.1 测试菜单权限过滤（有权限/无权限）
  - [ ] 6.2.2 测试路由守卫（无权限访问时的行为）
  - [ ] 6.2.3 测试角色权限分配功能
  - [ ] 6.2.4 测试管理员显示所有菜单
- [ ] 6.3 集成测试
  - [ ] 6.3.1 测试完整权限流程：创建角色 → 分配权限 → 分配用户 → 验证访问
  - [ ] 6.3.2 测试权限变更后的实时生效
  - [ ] 6.3.3 测试管理员用户不受权限限制

## 7. 文档更新

- [ ] 7.1 更新 API 文档
  - [ ] 7.1.1 更新 Swagger 文档，添加权限要求说明
  - [ ] 7.1.2 记录所有菜单权限定义
- [ ] 7.2 更新用户文档
  - [ ] 7.2.1 更新角色管理使用说明
  - [ ] 7.2.2 添加权限分配指南
