# Design: 运维执行页面重构为快速执行操作台

## Context

当前 `/executions` 页面采用的是 GitHub Actions 风格的双栏布局（左侧工作流列表 + 右侧详情），需要先创建任务再执行。用户希望简化为一个**快速执行操作台**，可以直接选择模板或输入脚本，选择主机，立即执行。

### 目标用户场景
1. **快速执行场景**：运维人员需要快速在多个主机上执行一个命令/脚本，不想创建任务
2. **模板复用场景**：从任务模板中选择，快速执行到选定主机
3. **保存执行场景**：执行后如果需要，可以选择保存为任务供后续使用

## Goals / Non-Goals

### Goals
- 简化执行流程：模板/自定义 → 选择主机 → 执行，三步完成
- 支持不创建任务直接执行（临时执行）
- 实时查看执行结果和日志
- 支持保存执行为任务（可选）

### Non-Goals
- 不改变任务管理功能（`/tasks` 页面保持不变）
- 不改变任务模板管理功能（`/templates` 页面保持不变）
- 不改变执行记录存储结构（仍使用现有的 `task_executions` 表）

## Decisions

### 1. 页面布局设计

**方案 A**: 单页表单式（选用）
- 顶部：模板选择/自定义模式切换
- 中间：脚本内容编辑区
- 底部：主机选择区 + 执行选项
- 执行后：结果显示区（展开在下方或侧边）

**方案 B**: 双栏式（保留现有）
- 左侧：历史任务列表
- 右侧：执行表单 + 结果

**决策**: 采用方案 A，因为目标是快速执行，不需要展示历史任务列表（历史可在 `/tasks` 查看）。

### 2. 执行流程设计

```
用户操作流程：
1. 选择模式（模板/自定义）
   ├─ 模板模式：选择模板 → 自动填充脚本
   └─ 自定义模式：输入脚本内容

2. 选择目标主机
   ├─ 按项目筛选
   ├─ 按环境筛选
   ├─ 搜索主机
   └─ 批量选择

3. 配置执行选项
   ├─ 执行方式（同步/异步）
   ├─ 超时时间
   └─ 是否保存为任务（可选）

4. 执行
   └─ 显示执行状态和实时日志

5. 查看结果（执行后）
   ├─ 每个主机的执行状态
   ├─ 执行日志
   └─ 可选：保存为任务
```

### 3. API 设计

**方案 A**: 新增 `POST /api/v1/executions/quick-execute` 端点（选用）
- 支持临时执行（不创建任务）
- 可选创建任务并执行

**方案 B**: 复用现有 API
- 先调用 `POST /executions` 创建任务
- 再调用 `POST /executions/:id/execute` 执行

**决策**: 采用方案 A，因为：
- 临时执行不需要创建任务记录
- 接口语义更清晰
- 减少不必要的数据库操作

### 4. 临时执行记录存储

**方案 A**: 创建任务记录，标记为临时（选用）
- 在 `tasks` 表中创建记录，`is_temporary` 标志
- 执行记录正常存储到 `task_executions`

**方案 B**: 不创建任务记录，只创建执行记录
- `task_executions` 的 `task_id` 可以为 NULL

**决策**: 采用方案 A，因为：
- 保持数据一致性
- 便于后续查询和管理
- 可以定期清理临时任务

### 5. UI 组件结构

```
ExecutionOperatorPage
├─ ExecutionModeSelector (模板/自定义切换)
├─ ScriptEditor (脚本编辑区，模板模式下只读)
├─ HostSelector (主机选择器，支持筛选和搜索)
├─ ExecutionOptions (执行方式、超时、保存选项)
├─ ExecuteButton (执行按钮)
└─ ExecutionResults (执行结果显示)
   ├─ ExecutionStatus (整体状态)
   └─ HostExecutionList (每个主机的执行详情)
      └─ InlineLogViewer (内联日志查看器)
```

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 临时任务过多占用存储 | 中 | 定期清理临时任务（如 7 天未使用） |
| 临时执行无法查看历史 | 低 | 提供保存为任务选项 |
| 用户习惯改变需要适应 | 低 | 保留历史任务查看入口 |

## Migration Plan

1. 重构 `TaskManagementPage.tsx` 为新设计
2. 保留 `ExecutionHistoryList.tsx` 和 `TaskExecutionLogs.tsx` 用于查看历史
3. 更新 API 调用（如需要新端点）
4. 测试执行流程
5. 迁移引导（如有需要）

## Open Questions

1. 临时任务是否需要自动清理？清理策略是什么？
2. 是否需要在执行前验证脚本语法？
3. 是否支持批量保存多个执行为任务？
